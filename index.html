<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Send Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: #0f172a;
      --bg-soft: #111827;
      --bg-softer: #020617;
      --border-subtle: #1f2937;
      --accent: #f97316;
      --accent-soft: #fed7aa;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.5);
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }

    .shell {
      max-width: 1180px;
      margin: 0 auto;
      width: 100%;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.02em;
    }

    .title-block span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .month-switch {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #111827, #020617);
      border-radius: var(--radius-pill);
      padding: 4px 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }

    .month-button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 6px;
      font-size: 1.2rem;
    }

    .month-label {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .pill-filter {
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,0.75);
      color: var(--text-muted);
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-filter select {
      background: transparent;
      border: none;
      color: inherit;
      font-size: inherit;
      outline: none;
    }

    .calendar-shell {
      background: rgba(15,23,42,0.95);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px 14px;
    }

    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 6px;
      padding: 0 2px;
    }

    .weekday {
      text-align: center;
      font-size: 0.70rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-muted);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .day-cell {
      position: relative;
      min-height: 120px;
      background: linear-gradient(145deg, #020617, #111827);
      border-radius: 14px;
      padding: 6px 6px 4px;
      border: 1px solid rgba(31,41,55,0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .day-cell.is-today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(249,115,22,0.6);
    }

    .day-number {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .day-count {
      font-size: 0.65rem;
      padding: 2px 7px;
      border-radius: 999px;
      color: #fef3c7;
      background: linear-gradient(135deg, #f97316, #fb923c);
      opacity: 0.85;
    }

    .day-events {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      padding-right: 1px;
    }

    .day-empty {
      font-size: 0.68rem;
      color: #4b5563;
      margin-top: 3px;
    }

    .event-card {
      position: relative;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top left, rgba(249,115,22,0.20), rgba(15,23,42,0.9));
      padding: 4px 7px 4px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1px;
      font-size: 0.7rem;
      text-align: left;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, opacity 0.12s ease;
    }

    .event-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
      border-color: rgba(249,115,22,0.9);
    }

    .event-time {
      font-size: 0.68rem;
      color: var(--accent-soft);
      letter-spacing: 0.04em;
    }

    .event-name {
      font-weight: 600;
      font-size: 0.72rem;
      line-height: 1.15;
      color: #e5e7eb;
      margin-top: 1px;
    }

    .event-audience {
      font-size: 0.67rem;
      color: #9ca3af;
    }

    .event-card.is-done {
      opacity: 0.45;
      border-style: dashed;
    }

    .event-done-badge {
      font-size: 0.62rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.7);
      color: #bbf7d0;
      margin-left: auto;
    }

    .objective-fundraising .event-card {
      background: radial-gradient(circle at top left, rgba(248,113,113,0.25), rgba(15,23,42,0.95));
      border-color: rgba(248,113,113,0.5);
    }

    .objective-engagement .event-card {
      background: radial-gradient(circle at top left, rgba(96,165,250,0.25), rgba(15,23,42,0.95));
      border-color: rgba(59,130,246,0.5);
    }

    .objective-thank-you .event-card {
      background: radial-gradient(circle at top left, rgba(52,211,153,0.25), rgba(15,23,42,0.95));
      border-color: rgba(52,211,153,0.55);
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.18s ease-out;
    }

    .modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.2), rgba(0,0,0,0.85));
      backdrop-filter: blur(8px);
    }

    .modal-panel {
      position: relative;
      max-width: 640px;
      width: 92%;
      background: linear-gradient(145deg, #020617, #111827);
      border-radius: 20px;
      border: 1px solid rgba(55,65,81,0.9);
      box-shadow: 0 28px 60px rgba(0,0,0,0.7);
      padding: 18px 18px 16px;
      color: var(--text);
      z-index: 1;
      transform: translateY(12px) scale(0.98);
      opacity: 0;
      transition: transform 0.18s ease-out, opacity 0.18s ease-out;
    }

    .modal.visible .modal-panel {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .modal-title {
      margin: 0;
      font-size: 1rem;
      line-height: 1.3;
    }

    .modal-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 2px 0 0;
    }

    .modal-close {
      border: none;
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      width: 28px;
      height: 28px;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 8px;
    }

    .done-toggle {
      border: none;
      border-radius: 999px;
      padding: 5px 11px;
      font-size: 0.75rem;
      cursor: pointer;
      background: rgba(34,197,94,0.12);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.6);
    }

    .done-toggle.is-off {
      background: rgba(148,163,184,0.1);
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.7);
    }

    .modal-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      font-size: 0.65rem;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
    }

    .badge-accent {
      border-color: rgba(249,115,22,0.9);
      color: var(--accent-soft);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 6px;
      font-size: 0.8rem;
    }

    .detail-item {
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
    }

    .detail-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .detail-value {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .primary-btn {
      border: none;
      border-radius: var(--radius-pill);
      padding: 7px 14px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #f97316, #fb923c);
      color: #111827;
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
    }

    .primary-btn:hover {
      box-shadow: 0 14px 28px rgba(0,0,0,0.7);
    }

    .secondary-btn {
      border: 1px solid rgba(148,163,184,0.7);
      border-radius: var(--radius-pill);
      padding: 5px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }

    .secondary-btn:hover {
      background: rgba(31,41,55,0.9);
    }

    .danger-btn {
      border: 1px solid rgba(248,113,113,0.7);
      border-radius: var(--radius-pill);
      padding: 5px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: rgba(248,113,113,0.16);
      color: #fecaca;
    }

    .danger-btn:hover {
      background: rgba(248,113,113,0.28);
    }

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.78rem;
    }

    .form-field label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .form-field input,
    .form-field textarea {
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.9);
      padding: 6px 8px;
      color: var(--text);
      font-size: 0.8rem;
      outline: none;
    }

    .form-field input:focus,
    .form-field textarea:focus {
      border-color: rgba(249,115,22,0.9);
    }

    .form-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    @media (max-width: 720px) {
      .form-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (min-width: 720px) {
      .detail-grid {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      }
    }

    @media (max-width: 768px) {
      .day-cell {
        min-height: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="title-block">
        <h1>Email Send Calendar</h1>
        <span>Clean view of Date → Time → Name → Audience, with all creative details one click away.</span>
      </div>
      <div class="controls">
        <button class="primary-btn" id="addEventBtn">+ New send</button>
        <div class="month-switch">
          <button class="month-button" id="prevMonth" aria-label="Previous month">‹</button>
          <div class="month-label" id="monthLabel"></div>
          <button class="month-button" id="nextMonth" aria-label="Next month">›</button>
        </div>
        <div class="pill-filter">
          Audience
          <select id="audienceFilter">
            <option value="">All</option>
          </select>
        </div>
      </div>
    </header>

    <div class="calendar-shell">
      <div class="weekday-row">
        <div class="weekday">Sun</div>
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>
  </div>

  <!-- Event details modal -->
  <div class="modal" id="eventModal" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="modalTitle"></h2>
          <p class="modal-meta" id="modalMeta"></p>
        </div>
        <button class="modal-close" id="modalClose" aria-label="Close">✕</button>
      </div>

      <div class="modal-actions">
        <button class="secondary-btn" id="modalEditBtn">Edit</button>
        <button class="danger-btn" id="modalDeleteBtn">Delete</button>
        <button class="done-toggle is-off" id="modalDoneBtn">
          Mark as done
        </button>
      </div>

      <div class="modal-badges" id="modalBadges"></div>
      <div class="detail-grid" id="modalDetails"></div>
    </div>
  </div>

  <!-- Create / edit event modal -->
  <div class="modal" id="createModal" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="createTitle">Add email send</h2>
          <p class="modal-meta">
            Create or edit a one-off send just for this calendar. It’s stored locally in this browser.
          </p>
        </div>
        <button class="modal-close" id="createClose" aria-label="Close">✕</button>
      </div>

      <form id="createForm" class="form-grid">
        <div class="form-row">
          <div class="form-field">
            <label for="createDate">Date</label>
            <input type="date" id="createDate" name="date" required />
          </div>
          <div class="form-field">
            <label for="createTime">Time (ET)</label>
            <input type="time" id="createTime" name="time" />
          </div>
        </div>

        <div class="form-field">
          <label for="createName">Name</label>
          <input type="text" id="createName" name="name" required />
        </div>

        <div class="form-row">
          <div class="form-field">
            <label for="createAudience">Audience</label>
            <input type="text" id="createAudience" name="audience" />
          </div>
          <div class="form-field">
            <label for="createObjective">Objective</label>
            <input type="text" id="createObjective" name="objective" />
          </div>
        </div>

        <div class="form-field">
          <label for="createSegment">Suppression / Segment</label>
          <input type="text" id="createSegment" name="segment" />
        </div>

        <div class="form-field">
          <label for="createKeyTakeaway">Key takeaway</label>
          <textarea id="createKeyTakeaway" name="key_takeaway" rows="2"></textarea>
        </div>

        <div class="form-field">
          <label for="createSubjectPrompt">Subject prompt</label>
          <textarea id="createSubjectPrompt" name="subject_prompt" rows="2"></textarea>
        </div>

        <div class="form-field">
          <label for="createKeyMessage">Key message</label>
          <textarea id="createKeyMessage" name="key_message" rows="2"></textarea>
        </div>

        <div class="form-field">
          <label for="createArtDirection">Art direction</label>
          <textarea id="createArtDirection" name="art_direction" rows="2"></textarea>
        </div>

        <div class="form-field">
          <label for="createSources">Sources / references</label>
          <textarea id="createSources" name="sources" rows="2"></textarea>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label for="createSender">Sender</label>
            <input type="text" id="createSender" name="sender" />
          </div>
          <div class="form-field">
            <label for="createBatch">Batch</label>
            <input type="text" id="createBatch" name="batch" />
          </div>
          <div class="form-field">
            <label for="createStatus">Status</label>
            <input type="text" id="createStatus" name="status" />
          </div>
        </div>

        <div class="form-footer">
          <button type="submit" class="primary-btn">Save send</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // DOM hooks
    const calendarGrid = document.getElementById("calendarGrid");
    const monthLabel = document.getElementById("monthLabel");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");
    const audienceFilter = document.getElementById("audienceFilter");

    const modal = document.getElementById("eventModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const modalBadges = document.getElementById("modalBadges");
    const modalDetails = document.getElementById("modalDetails");
    const modalClose = document.getElementById("modalClose");
    const modalDoneBtn = document.getElementById("modalDoneBtn");
    const modalDeleteBtn = document.getElementById("modalDeleteBtn");
    const modalEditBtn = document.getElementById("modalEditBtn");

    const addEventBtn = document.getElementById("addEventBtn");
    const createModal = document.getElementById("createModal");
    const createClose = document.getElementById("createClose");
    const createForm = document.getElementById("createForm");
    const createTitle = document.getElementById("createTitle");

    // Local storage keys
    const STORAGE_KEY = "emailCalendarDone";
    const CUSTOM_KEY = "emailCalendarCustomRaw";

    // State
    let doneMap = {};
    let currentEventId = null;

    let baseRaw = [];
    let customRawEvents = [];
    let allEvents = [];
    let currentYear;
    let currentMonth; // 0-based

    let currentEventSource = null; // "base" or "custom"
    let currentEventIndex = null;  // index into baseRaw/customRawEvents

    let editMode = false;  // are we editing an existing custom event?
    let editIndex = null;  // which index in customRawEvents is being edited

    const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];

    // ----- storage helpers -----
    function loadDoneMap() {
      try {
        doneMap = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      } catch {
        doneMap = {};
      }
    }

    function saveDoneMap() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(doneMap));
    }

    function loadCustomRaw() {
      try {
        customRawEvents = JSON.parse(localStorage.getItem(CUSTOM_KEY) || "[]");
      } catch {
        customRawEvents = [];
      }
    }

    function saveCustomRaw() {
      localStorage.setItem(CUSTOM_KEY, JSON.stringify(customRawEvents));
    }

    // ----- event id -----
    function makeEventId(ev) {
      return `${ev.date}|${ev.rawTime || ""}|${ev.name || ""}`;
    }

    // ----- time & field helpers -----
    function formatTimeDisplay(raw) {
      const s = String(raw || "").trim();
      if (!s || s === "NaN") return "";
      const m = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if (m) {
        let h = parseInt(m[1], 10);
        const mm = m[2];
        const suffix = h >= 12 ? "PM" : "AM";
        if (h === 0) h = 12;
        if (h > 12) h -= 12;
        return `${h}:${mm} ${suffix} ET`;
      }
      return s;
    }

    function getRawDate(e) {
      return e.date || e.Date || e["Date:"] || e["UUSA Email Send Table"] || "";
    }

    function getRawTime(e) {
      return e.time || e.Time || e["Time:"] || "";
    }

    function mapEvent(e) {
      const rawDate = getRawDate(e);
      const d = new Date(rawDate);
      if (isNaN(d.getTime())) {
        console.warn("Skipping event with invalid date:", rawDate, e);
        return null;
      }

      const rawTime = getRawTime(e);

      return {
        ...e,
        date: d.toISOString().slice(0, 10),
        year: d.getFullYear(),
        month: d.getMonth(),
        day: d.getDate(),
        rawTime,
        timeDisplay: formatTimeDisplay(rawTime),
        objective: e.objective || e["Objective: "] || e["Objective"] || e["Objective:"] || "",
        audience: e.audience || e["Audience:"] || e["Audience"] || "",
        segment: e.segment || e["Supression"] || e["Suppression"] || "",
        key_takeaway: e.key_takeaway || e["Key Takeaway"] || "",
        subject_prompt: e.subject_prompt || e["Subject Prompt:"] || "",
        key_message: e.key_message || e["Key Message"] || "",
        sources: e.sources || e["Potential Source(s):"] || "",
        art_direction: e.art_direction || e["Art Direction:"] || "",
        sender: e.sender || e["Sender:"] || "",
        batch: e.batch || e["Batch"] || "",
        status: e.status || e["Status:"] || "",
        objectiveKey: ((e.objective || e["Objective: "] || "") + "")
          .toLowerCase()
          .trim()
          .replace(/\s+/g, "-"),
      };
    }

    function rebuildAllEvents() {
      const baseMapped = (baseRaw || []).map((raw, idx) => {
        const ev = mapEvent(raw);
        if (!ev) return null;
        ev._source = "base";
        ev._rawIndex = idx;
        return ev;
      }).filter(Boolean);

      const customMapped = (customRawEvents || []).map((raw, idx) => {
        const ev = mapEvent(raw);
        if (!ev) return null;
        ev._source = "custom";
        ev._rawIndex = idx;
        return ev;
      }).filter(Boolean);

      allEvents = baseMapped.concat(customMapped);
    }

    // ----- load data -----
    fetch("schedule.json")
      .then(res => res.json())
      .catch(() => [])
      .then(data => {
        baseRaw = data || [];

        loadCustomRaw();
        rebuildAllEvents();
        loadDoneMap();

        if (allEvents.length) {
          currentYear = allEvents[0].year;
          currentMonth = allEvents[0].month;
        } else {
          const now = new Date();
          currentYear = now.getFullYear();
          currentMonth = now.getMonth();
        }

        initAudienceFilter();
        renderCalendar();
      })
      .catch(err => {
        console.error("Failed to load schedule.json", err);
      });

    // ----- UI building -----
    function initAudienceFilter() {
      const audiences = Array.from(new Set(
        allEvents
          .map(e => (e.audience || "").trim())
          .filter(Boolean)
      )).sort();

      for (const aud of audiences) {
        const opt = document.createElement("option");
        opt.value = aud;
        opt.textContent = aud;
        audienceFilter.appendChild(opt);
      }

      audienceFilter.addEventListener("change", renderCalendar);
    }

    function renderCalendar() {
      calendarGrid.innerHTML = "";
      monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;

      const firstOfMonth = new Date(currentYear, currentMonth, 1);
      const startWeekday = firstOfMonth.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const today = new Date();

      const activeAudience = audienceFilter.value;
      const monthEvents = allEvents.filter(e =>
        e.year === currentYear &&
        e.month === currentMonth &&
        (!activeAudience || e.audience === activeAudience)
      );

      const byDay = {};
      for (const ev of monthEvents) {
        if (!byDay[ev.day]) byDay[ev.day] = [];
        byDay[ev.day].push(ev);
      }
      for (const d in byDay) {
        byDay[d].sort((a, b) => (a.rawTime || "").localeCompare(b.rawTime || ""));
      }

      for (let i = 0; i < startWeekday; i++) {
        const empty = document.createElement("div");
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        const todaysCell =
          day === today.getDate() &&
          currentMonth === today.getMonth() &&
          currentYear === today.getFullYear();

        cell.className = "day-cell" + (todaysCell ? " is-today" : "");

        const header = document.createElement("div");
        header.className = "day-number";

        const dayNumberSpan = document.createElement("span");
        dayNumberSpan.textContent = day;
        header.appendChild(dayNumberSpan);

        const eventsForDay = byDay[day] || [];
        if (eventsForDay.length > 0) {
          const count = document.createElement("span");
          count.className = "day-count";
          count.textContent = eventsForDay.length + (eventsForDay.length === 1 ? " send" : " sends");
          header.appendChild(count);
        }

        cell.appendChild(header);

        const eventsContainer = document.createElement("div");
        eventsContainer.className = "day-events";

        if (!eventsForDay.length) {
          const emptyMsg = document.createElement("div");
          emptyMsg.className = "day-empty";
          emptyMsg.textContent = "No sends";
          eventsContainer.appendChild(emptyMsg);
        } else {
          for (const ev of eventsForDay) {
            const wrapper = document.createElement("div");
            wrapper.className = `objective-${ev.objectiveKey || "default"}`;

            const card = document.createElement("div");
            card.className = "event-card";

            const id = makeEventId(ev);
            card.dataset.eventId = id;
            if (doneMap[id]) {
              card.classList.add("is-done");
            }

            const time = document.createElement("div");
            time.className = "event-time";
            time.textContent = ev.timeDisplay || "All day";

            const name = document.createElement("div");
            name.className = "event-name";
            name.textContent = ev.name || "(Untitled send)";

            const metaRow = document.createElement("div");
            metaRow.style.display = "flex";
            metaRow.style.alignItems = "center";
            metaRow.style.gap = "6px";
            metaRow.style.marginTop = "1px";

            const audience = document.createElement("div");
            audience.className = "event-audience";
            audience.textContent = ev.audience || "";

            metaRow.appendChild(audience);

            if (doneMap[id]) {
              const doneBadge = document.createElement("span");
              doneBadge.className = "event-done-badge";
              doneBadge.textContent = "Done";
              metaRow.appendChild(doneBadge);
            }

            card.appendChild(time);
            card.appendChild(name);
            card.appendChild(metaRow);

            card.addEventListener("click", () => openModal(ev, id));
            wrapper.appendChild(card);
            eventsContainer.appendChild(wrapper);
          }
        }

        cell.appendChild(eventsContainer);
        calendarGrid.appendChild(cell);
      }
    }

    // ----- modals -----
    function openModal(ev, id) {
      currentEventId = id;
      currentEventSource = ev._source || "base";
      currentEventIndex = ev._rawIndex;

      modalTitle.textContent = ev.name || "(Untitled send)";

      const dateObj = new Date(ev.year, ev.month, ev.day);
      const weekDay = weekdayNames[dateObj.getDay()];
      const dateStr = `${weekDay}, ${monthNames[ev.month]} ${ev.day}, ${ev.year}`;
      const timeStr = ev.timeDisplay ? ` • ${ev.timeDisplay}` : "";
      modalMeta.textContent = dateStr + timeStr;

      // show edit/delete only for custom events
      if (currentEventSource === "custom") {
        modalDeleteBtn.style.display = "inline-flex";
        modalEditBtn.style.display = "inline-flex";
      } else {
        modalDeleteBtn.style.display = "none";
        modalEditBtn.style.display = "none";
      }

      modalBadges.innerHTML = "";
      const badges = [];
      if (ev.audience) badges.push({ text: ev.audience, accent: true });

      for (const b of badges) {
        const span = document.createElement("span");
        span.className = "badge" + (b.accent ? " badge-accent" : "");
        span.textContent = b.text;
        modalBadges.appendChild(span);
      }

      const detailFields = [
        ["Objective", ev.objective],
        ["Audience", ev.audience],
        ["Suppression / Segment", ev.segment],
        ["Key takeaway", ev.key_takeaway],
        ["Subject prompt", ev.subject_prompt],
        ["Key message", ev.key_message],
        ["Art direction", ev.art_direction],
        ["Sources / references", ev.sources],
        ["Sender", ev.sender],
        ["Batch", ev.batch],
        ["Status", ev.status],
      ];

      modalDetails.innerHTML = "";
      for (const [label, value] of detailFields) {
        if (!value) continue;
        const item = document.createElement("div");
        item.className = "detail-item";

        const lbl = document.createElement("div");
        lbl.className = "detail-label";
        lbl.textContent = label;

        const val = document.createElement("div");
        val.className = "detail-value";
        val.textContent = value;

        item.appendChild(lbl);
        item.appendChild(val);
        modalDetails.appendChild(item);
      }

      const isDone = !!doneMap[id];
      if (isDone) {
        modalDoneBtn.textContent = "Mark as not done";
        modalDoneBtn.classList.remove("is-off");
      } else {
        modalDoneBtn.textContent = "Mark as done";
        modalDoneBtn.classList.add("is-off");
      }

      modal.classList.add("visible");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      modal.classList.remove("visible");
      modal.setAttribute("aria-hidden", "true");
    }

    function openCreateModal(prefillDate, raw, index) {
      createForm.reset();

      if (raw) {
        // edit mode
        editMode = true;
        editIndex = index;
        createTitle.textContent = "Edit email send";

        createForm.date.value = raw.date || "";
        createForm.time.value = raw.time || "";
        createForm.name.value = raw.name || "";
        createForm.audience.value = raw.audience || "";
        createForm.objective.value = raw.objective || "";
        createForm.segment.value = raw.segment || "";
        createForm.key_takeaway.value = raw.key_takeaway || "";
        createForm.subject_prompt.value = raw.subject_prompt || "";
        createForm.key_message.value = raw.key_message || "";
        createForm.art_direction.value = raw.art_direction || "";
        createForm.sources.value = raw.sources || "";
        createForm.sender.value = raw.sender || "";
        createForm.batch.value = raw.batch || "";
        createForm.status.value = raw.status || "";
      } else {
        // create mode
        editMode = false;
        editIndex = null;
        createTitle.textContent = "Add email send";
        if (prefillDate) {
          createForm.date.value = prefillDate;
        }
      }

      createModal.classList.add("visible");
      createModal.setAttribute("aria-hidden", "false");
    }

    function closeCreateModal() {
      createModal.classList.remove("visible");
      createModal.setAttribute("aria-hidden", "true");
      editMode = false;
      editIndex = null;
    }

    // ----- listeners -----
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal || e.target.classList.contains("modal-backdrop")) {
        closeModal();
      }
    });

    modalDoneBtn.addEventListener("click", () => {
      if (!currentEventId) return;

      if (doneMap[currentEventId]) {
        delete doneMap[currentEventId];
      } else {
        doneMap[currentEventId] = true;
      }
      saveDoneMap();

      const isDoneNow = !!doneMap[currentEventId];
      if (isDoneNow) {
        modalDoneBtn.textContent = "Mark as not done";
        modalDoneBtn.classList.remove("is-off");
      } else {
        modalDoneBtn.textContent = "Mark as done";
        modalDoneBtn.classList.add("is-off");
      }

      renderCalendar();
    });

    modalDeleteBtn.addEventListener("click", () => {
      if (currentEventSource !== "custom" || currentEventIndex == null) {
        return;
      }
      if (!confirm("Delete this custom send from your calendar?")) return;

      customRawEvents.splice(currentEventIndex, 1);
      saveCustomRaw();
      rebuildAllEvents();
      closeModal();
      renderCalendar();
    });

    modalEditBtn.addEventListener("click", () => {
      if (currentEventSource !== "custom" || currentEventIndex == null) {
        return;
      }
      const raw = customRawEvents[currentEventIndex];
      openCreateModal(null, raw, currentEventIndex);
    });

    prevMonthBtn.addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });

    nextMonthBtn.addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });

    addEventBtn.addEventListener("click", () => openCreateModal());

    createClose.addEventListener("click", closeCreateModal);

    createModal.addEventListener("click", (e) => {
      if (e.target === createModal || e.target.classList.contains("modal-backdrop")) {
        closeCreateModal();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (createModal.classList.contains("visible")) {
          closeCreateModal();
        } else if (modal.classList.contains("visible")) {
          closeModal();
        }
      }
    });

    createForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const raw = {
        date: createForm.date.value,
        time: createForm.time.value,
        name: createForm.name.value,
        audience: createForm.audience.value,
        objective: createForm.objective.value,
        segment: createForm.segment.value,
        key_takeaway: createForm.key_takeaway.value,
        subject_prompt: createForm.subject_prompt.value,
        key_message: createForm.key_message.value,
        art_direction: createForm.art_direction.value,
        sources: createForm.sources.value,
        sender: createForm.sender.value,
        batch: createForm.batch.value,
        status: createForm.status.value,
      };

      if (!raw.date || !raw.name) {
        alert("Please set at least a date and a name.");
        return;
      }

      let targetIndex;
      if (editMode && editIndex != null) {
        customRawEvents[editIndex] = raw;
        targetIndex = editIndex;
      } else {
        customRawEvents.push(raw);
        targetIndex = customRawEvents.length - 1;
      }

      saveCustomRaw();
      rebuildAllEvents();

      const mapped = allEvents.find(
        ev => ev._source === "custom" && ev._rawIndex === targetIndex
      );
      if (mapped) {
        currentYear = mapped.year;
        currentMonth = mapped.month;

        // extend audience filter if new audience
        if (mapped.audience) {
          let found = false;
          for (const opt of audienceFilter.options) {
            if (opt.value === mapped.audience) {
              found = true;
              break;
            }
          }
          if (!found) {
            const opt = document.createElement("option");
            opt.value = mapped.audience;
            opt.textContent = mapped.audience;
            audienceFilter.appendChild(opt);
          }
        }
      }

      renderCalendar();
      closeCreateModal();
    });
  </script>
</body>
</html>
